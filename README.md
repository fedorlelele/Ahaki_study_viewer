# Ahaki_study_viewer

国試テキスト（UTF-16のTXT）から、問題データを整理して SQLite / JSON へ保存し、
解説・タグ・小項目（サブトピック）を追加していくためのスクリプト群です。

## 前提
- Python 3
- pandas

## ディレクトリ構成
- `kokushitxt/` : 元のTXTファイル
- `output/` : 生成物（SQLite / JSON など）
- `convert_ahaki_to_json.py` : 既存のTXT -> Excel/JS 変換
- `build_ahaki_sqlite.py` : TXT -> SQLite + 1問1JSON 生成
- `scripts/generate_explanation_template.py` : 解説用JSONLテンプレ生成
- `scripts/import_explanations.py` : 解説JSONLのSQLite取り込み
- `scripts/generate_tag_template.py` : タグ用JSONLテンプレ生成
- `scripts/import_tags.py` : タグJSONLのSQLite取り込み
- `scripts/generate_subtopic_catalog.py` : 科目ごとの小項目カタログ雛形生成
- `scripts/generate_subtopic_assignment_template.py` : 小項目割当用JSONL生成
- `scripts/import_subtopics.py` : 小項目JSONLのSQLite取り込み
- `config/subtopics_catalog.json` : 小項目カタログ（管理対象）
- `scripts/generate_web_json.py` : WebUI用JSON生成
- `local_admin_app.py` : ローカル管理画面
- `web_app/` : WebUI
- `samples/` : サンプル・プロンプト素材
- `resources/` : プロンプト用のサンプルJSONLなど（管理対象）

## 1. SQLite生成（元TXTから）
```
python build_ahaki_sqlite.py
```
出力:
- `output/ahaki.sqlite`
- `output/questions_json/`（1問1JSON）

## 2. 解説の追加（JSONL）
### 2-1. テンプレ生成（10問）
```
python scripts/generate_explanation_template.py --limit 10 \
  --out output/explanations_batch.jsonl \
  --prompt-out output/explanations_batch_prompt.txt
```

### 2-2. LLMで解説を埋める
- `explanations_batch_prompt.txt` をWeb版に貼り付け
- `explanations_batch_filled.jsonl` として保存

### 2-3. SQLiteに取り込み
```
python scripts/import_explanations.py --infile output/explanations_batch_filled.jsonl
```

## 3. タグ付け（JSONL）
### 3-1. テンプレ生成（10問）
```
python scripts/generate_tag_template.py --limit 10 \
  --out output/tags_batch.jsonl \
  --prompt-out output/tags_batch_prompt.txt
```

### 3-2. LLMでタグを埋める
- `tags_batch_prompt.txt` をWeb版に貼り付け
- `tags_batch_filled.jsonl` として保存

### 3-3. SQLiteに取り込み
```
python scripts/import_tags.py --infile output/tags_batch_filled.jsonl
```

## 4. 小項目（サブトピック）
### 4-1. 科目ごとの候補リスト作成
```
python scripts/generate_subtopic_catalog.py --out config/subtopics_catalog.json
```
`config/subtopics_catalog.json` を編集して、科目ごとに候補リストを記入します。

### 4-2. 割り当て用JSONL生成
```
python scripts/generate_subtopic_assignment_template.py --limit 10 \
  --catalog config/subtopics_catalog.json \
  --out output/subtopics_batch.jsonl \
  --prompt-out output/subtopics_batch_prompt.txt
```

### 4-3. LLMで小項目を割り当て
- `subtopics_batch_prompt.txt` をWeb版に貼り付け
- `subtopics_batch_filled.jsonl` として保存

### 4-4. SQLiteに取り込み
```
python scripts/import_subtopics.py --infile output/subtopics_batch_filled.jsonl
```

## SQLite確認（例）
```
sqlite3 output/ahaki.sqlite
.tables
SELECT q.serial, s.name, q.stem
FROM questions q
LEFT JOIN subjects s ON q.subject_id = s.id
LIMIT 5;
```

## 補足
- LLMの出力は「JSONLファイルとして保存して返す」指定になっています。
- 既存データを壊さず、追記型で解説・タグ・小項目を蓄積します。
- `output/` は生成物のため `.gitignore` で除外しています。

## 5. Webアプリ簡易ビュー
`web_app/index.html` に検索・絞り込み・コピー機能を備えた簡易ビューがあります。

### 起動方法
```
python -m http.server 8000
```
ブラウザで `http://127.0.0.1:8000/web_app/` を開いてください。
※ 事前に `scripts/generate_web_json.py` を実行し、`output/web/` にJSONを生成しておく必要があります。

### Supabase設定（WebUI）
`web_app/config.example.js` を `web_app/config.js` にコピーして、
Supabaseの `Publishable key` と `Project URL` を設定してください。
`web_app/config.js` は `.gitignore` で除外されています。

## 7. GitHub Pagesで公開
GitHub Pagesを使う場合は `docs/` に公開用ファイルを生成します。

```
python scripts/generate_web_json.py
bash scripts/prepare_pages.sh
```

GitHubのSettings → Pagesで `docs/` を公開対象に設定し、公開URLの
`/web_app/` を開くとWebUIが表示されます。

## Supabase テーブル（編集提案）
編集提案を保存するために `edit_requests` を追加します。

```sql
create table if not exists edit_requests (
  id bigint generated by default as identity primary key,
  serial text not null,
  kind text not null,
  payload jsonb not null default '{}'::jsonb,
  note text,
  status text not null default 'open',
  created_at timestamptz default now(),
  created_by text,
  created_email text
);

alter table edit_requests enable row level security;

create policy "teacher insert edit_requests"
  on edit_requests for insert
  with check (true);
```

### 機能
- キーワード検索（空白区切りのAND検索）
- タグ検索はキーワードに `#タグ名` を指定
- 科目/小項目/試験種別/回数の絞り込み、回数ソート
- 正答表示 / 正答・解説表示の切り替え
- 解説は最新版を表示し、バージョン選択で切り替え可能
- 症例文（case_text）の表示に対応
- 解説・タグ・小項目の要修正報告ボタン
- 検索結果全体のコピー（検索条件付き）
- 各問題の個別コピー
- タグ/小項目をクリックして関連問題にジャンプ

### ショートカットキー
- `/` キーワード入力へ移動
- `s` 科目セレクトへ移動
- `u` 小項目セレクトへ移動
- `f` 検索実行
- `r` リセット
- `a` 正答表示の切替
- `e` 正答・解説表示の切替

## 6. ローカル管理画面（local_admin_app.py）
解説・タグ・小項目のプロンプト生成/インポート/進捗確認などを行うローカルUIです。

### 起動
```
python local_admin_app.py --port 8001
```

### 主な機能
- プロンプト一括生成（ダウンロード or クリップボード）
- 解説/タグ/小項目の生成対象を個別に選択
- 新しい順/古い順、試験種別/回数/科目のフィルタ
- 解説/タグ/小項目の個別インポート
- フォルダ指定の一括インポート
  - `explanations_batch_filled.jsonl`
  - `tags_batch_filled.jsonl`
  - `subtopics_batch_filled.jsonl`
- ダウンロードフォルダ一括インポート（`*_batch_filled*.jsonl`）
- クリップボード貼り付けインポート
- 進捗レポート表示
- 履歴表示（最新20件）
- 検索・プレビュー
- 未設定一覧（JSON表示/CSVダウンロード）
- 報告一覧の確認、プロンプト対象へのセット、報告フラグ消去
- 報告一覧はSupabaseのfeedbackを参照（SUPABASE_URL / SUPABASE_SERVICE_KEYが必要）
- 解説/タグ/小項目のインポート時に該当報告フラグを自動消去（Supabase側も消去）
- 編集提案（edit_requests）を一覧表示し、SQLiteへ反映／却下が可能
- WebUI用ファイル生成 / 一括生成

### WebUI反映について
管理画面からのインポート時に、WebUI用ファイル（`output/web/`）を
自動で再生成します。WebUIの表示が古い場合はブラウザを強制リロードしてください。

## 7. Gemini APIでの一括自動生成（CLI）
Gemini 3 Flash preview（思考モード）で、解説・タグ・小項目の一括生成を
20問単位で実行し、JSONLを自動インポートします。

### 事前準備
`.env` にAPIキーを保存（gitignore済み）。
```
GEMINI_API_KEY=YOUR_KEY
```

### 実行例
```
python scripts/run_gemini_combined.py --limit 20 --batches 3 --sleep-seconds 20
```

### 主なオプション
- `--batches` : 実行回数（1回=20問）
- `--sleep-seconds` : バッチ間の待機秒数（無料枠対策）
- `--max-per-day` : 1日あたりの上限回数（既定25）
- `--model` : 使用モデルID（既定 `gemini-3.0-flash-preview`）
- `--thinking-budget` : 思考モードの予算（0で無効）
- `--unannotated` / `--all` : 未設定のみ / 既存を含む
- `--rebuild-web` / `--no-rebuild-web` : WebUI用データ再生成の有無

実行履歴は `output/gemini_usage.json` に記録されます。
